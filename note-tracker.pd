#N canvas 59 -1082 1190 914 10;
#X obj 540 200 text define \$1;
#X text 540 227 \$1 is the text store name;
#X obj 110 50 inlet;
#X text 160 50 Pitch and velocity pair;
#X obj 110 75 t a a;
#X obj 167 242 list store;
#X obj 50 470 list store;
#X obj 70 120 unpack f f;
#X obj 93 153 sel 0;
#X obj 167 211 t b;
#X obj 167 412 text insert \$1 1e+09;
#X obj 169 114 t a a a;
#N canvas 332 188 858 538 delete-entry 0;
#X obj 70 30 inlet;
#X text 120 30 Pitch and velocity pair;
#X obj 70 55 unpack f f;
#X obj 70 80 text search \$1;
#X obj 121 219 text delete \$1;
#X obj 70 109 select -1;
#X obj 70 264 text size \$1;
#X obj 70 289 select 6;
#X obj 70 429 text delete \$1;
#X text 137 193 If we have found that note \, delete its line;
#X text 117 314 If there are already six lines delete the first;
#X obj 200 429 text get \$1 4;
#X obj 200 474 outlet;
#X obj 70 404 f 0;
#X obj 70 314 t b b;
#X obj 200 404 f 0;
#X text 240 403 Capture which tape (from the first line) to stop;
#X text 250 70 Given a pitch/velocity pair \, delete a line to make
way for a new one \, if necessary. Output a tape to stop \, if there
is one.;
#X text 250 120 Logic: (1) If there's already a line with that pitch
then delete that. Else (2) if there are six lines already delete the
top line (the oldest) - and we'll need to stop that tape. Else there's
nothing to do.;
#X connect 0 0 2 0;
#X connect 2 0 3 0;
#X connect 3 0 5 0;
#X connect 5 0 6 0;
#X connect 5 1 4 0;
#X connect 6 0 7 0;
#X connect 7 0 14 0;
#X connect 11 0 12 0;
#X connect 13 0 8 0;
#X connect 14 0 13 0;
#X connect 14 1 15 0;
#X connect 15 0 11 0;
#X restore 216 295 pd delete-entry;
#X text 241 242 Store the note pair in case it's note on;
#X text 130 469 Store the note pair in case it's note off;
#X text 290 387 Add extra values and insert the line;
#X obj 50 430 t b;
#X obj 288 91 r beat-clock;
#X obj 288 116 t b;
#X obj 288 160 f 0;
#X obj 330 160 + 1;
#X floatatom 270 210 20 0 0 0 - - -, f 20;
#X obj 330 185 s beat-count-\$0;
#X obj 330 130 r beat-count-\$0;
#X obj 167 267 t a b a;
#X obj 187 349 v beat-count-\$0;
#N canvas 448 160 906 450 get-note-duration 0;
#X obj 70 50 inlet;
#X text 340 50 \$1 is the text store name;
#X obj 76 217 -;
#X obj 20 124 v beat-count-\$0;
#X obj 76 322 outlet;
#X obj 250 110 t 0;
#X obj 76 262 spigot 0;
#X obj 130 150 t a 1;
#X text 340 90 Output the duration of a note \, which is the beat count
now minus the beat count from note-on. The second outlet bangs if there
is not record of the note-on.;
#X obj 204 260 outlet;
#X text 100 283 Only output if we've found the note;
#X obj 130 125 text get \$1 2;
#X text 120 50 Line in \$1 of the data;
#X obj 70 75 t b f b;
#X connect 0 0 13 0;
#X connect 2 0 6 0;
#X connect 3 0 2 0;
#X connect 5 0 6 1;
#X connect 6 0 4 0;
#X connect 7 0 2 1;
#X connect 7 1 6 1;
#X connect 11 0 7 0;
#X connect 11 1 9 0;
#X connect 13 0 3 0;
#X connect 13 1 11 0;
#X connect 13 2 5 0;
#X restore 370 646 pd get-note-duration;
#X text 540 250 Text stores pitch \, velocity \, note duration \, tape
duration \, tape number (starts from 0).;
#X obj 167 387 pack f f 0 -99 -1;
#N canvas 91 -1087 1161 914 get-next-tape-num 1;
#X obj 80 50 inlet;
#X text 270 30 \$1 is the text store name;
#X text 130 50 Bang;
#X obj 87 247 f 0;
#X obj 67 214 until;
#X obj 140 250 + 1;
#X obj 88 420 f;
#X text 148 420 The value we searched for;
#X obj 88 370 select -1;
#X obj 88 395 t b;
#X text 138 390 We didn't find it \, so output it;
#X obj 73 496 f;
#X obj 510 435 text insert mytest;
#X obj 510 220 text define mytest;
#X text 140 180 Initial values \, incl -1 if not found;
#X obj 80 180 t 6 0 -1;
#X obj 53 107 t b b;
#X text 103 496 Save up a value \, output it at the end;
#X obj 87 276 t f f;
#X msg 510 384 list 0 0 0 0 5 \, list 0 0 0 0 2 \, list 0 0 0 0 1 \,
list 0 0 0 0 4 \, list 0 0 0 0 0 \, list 0 0 0 0 3;
#X text 510 190 Data for testing;
#X obj 510 551 text insert mytest;
#X msg 510 500 list 0 0 0 0 5 \, list 0 0 0 0 2 \, list 0 0 0 0 1 \,
list 0 0 0 0 4 \, list 0 0 0 0 0 \, list 0 0 0 0 3;
#X text 510 476 Text with everything present \, should emit -1;
#X text 510 360 Text with a 3 missing \, should emit 3;
#X obj 510 671 text insert mytest;
#X text 510 596 Text with a 3 and a 4 missing \, should emit only one
of these;
#X msg 510 620 list 0 0 0 0 5 \, list 0 0 0 0 2 \, list 0 0 0 0 1 \,
list 0 0 0 0 0;
#X obj 510 317 text delete mytest;
#X msg 510 293 -1;
#X text 510 267 Clear the text;
#X obj 73 521 outlet;
#X text 270 70 Output number of the next tape to be used. The logic
is to search for each tape number \, and store any not found \, and
finally output whatever was last stored.;
#X obj 88 345 text search \$1 4;
#X obj 400 270 t a;
#X obj 400 415 t a;
#X obj 23 392 t a;
#X text 138 320 Use \$1 for real \, mytest for testing;
#X connect 0 0 16 0;
#X connect 3 0 5 0;
#X connect 3 0 18 0;
#X connect 4 0 3 0;
#X connect 5 0 3 1;
#X connect 6 0 11 1;
#X connect 8 0 9 0;
#X connect 9 0 6 0;
#X connect 11 0 31 0;
#X connect 15 0 4 0;
#X connect 15 1 3 1;
#X connect 15 2 34 0;
#X connect 16 0 36 0;
#X connect 16 1 15 0;
#X connect 18 0 33 0;
#X connect 18 1 6 1;
#X connect 19 0 12 0;
#X connect 22 0 21 0;
#X connect 27 0 25 0;
#X connect 29 0 28 0;
#X connect 33 0 8 0;
#X connect 34 0 35 0;
#X connect 35 0 11 1;
#X connect 36 0 11 0;
#X restore 590 647 pd get-next-tape-num;
#X obj 50 776 outlet;
#X text 540 300 With thanks to Critter & Guitari for cg-note-tracker
\, which can be found in the Pink Mode pattern.;
#X obj 50 495 find-line \$1;
#X obj 729 647 f;
#X obj 510 647 f;
#X obj 50 601 text get \$1;
#X obj 370 696 text set \$1 0 2;
#X obj 590 697 text set \$1 0 4;
#X obj 370 602 t f f;
#X obj 590 603 t b f;
#X obj 170 735 text set \$1 0 3;
#N canvas 198 238 908 452 calc-tape-duration 0;
#X obj 160 50 inlet;
#X obj 145 302 outlet;
#X text 210 50 Note duration;
#X obj 160 205 random;
#X obj 160 170 t b f;
#X obj 160 75 t f f;
#X obj 236 198 * 3;
#X obj 160 245 +;
#X obj 160 115 * 3;
#X obj 160 142 + 1;
#X obj 50 50 inlet;
#X text 260 100 Calculate the duration of a tape. This is 3 to 6 times
its the note duration. Bang to output the value.;
#X text 90 50 Bang;
#X obj 145 270 f;
#X connect 0 0 5 0;
#X connect 3 0 7 0;
#X connect 4 0 3 0;
#X connect 4 1 3 1;
#X connect 5 0 8 0;
#X connect 5 1 6 0;
#X connect 6 0 7 1;
#X connect 7 0 13 1;
#X connect 8 0 9 0;
#X connect 9 0 4 0;
#X connect 10 0 13 0;
#X connect 13 0 1 0;
#X restore 170 695 pd calc-tape-duration;
#X obj 50 552 t f f f f;
#X obj 170 602 t b f;
#X text 769 648 Value \, line number;
#X msg 653 170 clear;
#X text 700 170 For use when testing;
#X obj 216 320 outlet;
#X text 270 320 Tape to stop (if any);
#X obj 540 415 r note-tracker-delete-tape;
#X text 712 414 Tape to delete;
#X obj 540 440 text search \$1 4;
#X obj 540 465 text delete \$1;
#X text 480 40 Track notes for the tape loops. First outlet outputs
a line if there is a new tape loop to set up. Second outlet says what
tape needs stopping \, if any. There's also an receiver to delete a
line by tape number.;
#X text 480 40 Track notes for the tape loops. First outlet outputs
a line if there is a new tape loop to set up. Second outlet says what
tape needs stopping \, if any. There's also an receiver to delete a
line by tape number.;
#X text 480 104 Logic: Note on writes an entry with dummy note duration
set at the current beat clock count \, tape duration has dummy value
-99 and tape number has dummy value -1;
#X obj 50 523 check-okay-to-track \$1;
#X connect 2 0 4 0;
#X connect 4 0 7 0;
#X connect 4 1 11 0;
#X connect 5 0 24 0;
#X connect 6 0 32 0;
#X connect 7 1 8 0;
#X connect 8 0 16 0;
#X connect 8 1 9 0;
#X connect 9 0 5 0;
#X connect 11 0 6 1;
#X connect 11 1 5 1;
#X connect 12 0 47 0;
#X connect 16 0 6 0;
#X connect 17 0 18 0;
#X connect 18 0 19 0;
#X connect 19 0 20 0;
#X connect 19 0 21 0;
#X connect 20 0 22 0;
#X connect 23 0 19 1;
#X connect 24 0 28 0;
#X connect 24 1 25 0;
#X connect 24 2 12 0;
#X connect 25 0 28 2;
#X connect 26 0 36 0;
#X connect 26 0 41 1;
#X connect 28 0 10 0;
#X connect 29 0 37 0;
#X connect 32 0 56 0;
#X connect 33 0 37 1;
#X connect 34 0 36 1;
#X connect 35 0 30 0;
#X connect 38 0 26 0;
#X connect 38 1 34 0;
#X connect 39 0 29 0;
#X connect 39 1 33 0;
#X connect 41 0 40 0;
#X connect 42 0 35 0;
#X connect 42 1 43 0;
#X connect 42 2 38 0;
#X connect 42 3 39 0;
#X connect 43 0 41 0;
#X connect 43 1 40 1;
#X connect 45 0 0 0;
#X connect 49 0 51 0;
#X connect 51 0 52 0;
#X connect 56 0 42 0;
