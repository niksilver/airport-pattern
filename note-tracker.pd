#N canvas 264 0 994 914 10;
#X obj 560 386 text define \$2;
#X obj 110 50 inlet;
#X text 160 50 Pitch and velocity pair;
#X obj 110 75 t a a;
#X obj 167 242 list store;
#X obj 50 500 list store;
#X obj 70 120 unpack f f;
#X obj 93 153 sel 0;
#X obj 167 211 t b;
#X obj 167 442 text insert \$2 1e+09;
#X obj 169 114 t a a a;
#N canvas 332 188 858 538 delete-entry 0;
#X obj 70 30 inlet;
#X text 120 30 Pitch and velocity pair;
#X obj 70 55 unpack f f;
#X obj 70 80 text search \$2;
#X obj 70 109 select -1;
#X obj 70 264 text size \$2;
#X obj 70 289 select 6;
#X obj 70 429 text delete \$2;
#X text 117 314 If there are already six lines delete the first;
#X obj 200 429 text get \$2 4;
#X obj 200 474 outlet;
#X obj 70 404 f 0;
#X obj 70 314 t b b;
#X obj 200 404 f 0;
#X text 240 403 Capture which tape (from the first line) to stop;
#X text 370 20 Given a pitch/velocity pair \, delete a line to make
way for a new one \, if necessary. Output a tape to stop \, if there
is one.;
#X text 370 70 Logic: (1) If there's already a line with that pitch
then delete that. Else (2) if there are six lines already delete the
top line (the oldest) - and we'll need to stop that tape. Else there's
nothing to do.;
#X text 260 180 If we have found that note \, capture the tape and
delete its line;
#X obj 190 180 t f f;
#X obj 250 220 text get \$2 4;
#X obj 130 220 text delete \$2;
#X connect 0 0 2 0;
#X connect 2 0 3 0;
#X connect 3 0 4 0;
#X connect 4 0 5 0;
#X connect 4 1 18 0;
#X connect 5 0 6 0;
#X connect 6 0 12 0;
#X connect 9 0 10 0;
#X connect 11 0 7 0;
#X connect 12 0 11 0;
#X connect 12 1 13 0;
#X connect 13 0 9 0;
#X connect 18 0 20 0;
#X connect 18 1 19 0;
#X connect 19 0 10 0;
#X restore 216 325 pd delete-entry;
#X text 241 242 Store the note pair in case it's note on;
#X text 130 499 Store the note pair in case it's note off;
#X text 290 417 Add extra values and insert the line;
#X obj 50 460 t b;
#X obj 288 91 r beat-clock;
#X obj 288 116 t b;
#X obj 288 160 f 0;
#X obj 330 160 + 1;
#X floatatom 270 210 20 0 0 0 - - -, f 20;
#N canvas 448 160 906 450 get-note-duration 0;
#X obj 70 50 inlet;
#X text 340 50 \$2 is the text store name;
#X obj 76 217 -;
#X obj 76 322 outlet;
#X obj 76 262 spigot 0;
#X text 340 90 Output the duration of a note \, which is the beat count
now minus the beat count from note-on. The second outlet bangs if there
is not record of the note-on.;
#X obj 204 260 outlet;
#X text 100 283 Only output if we've found the note;
#X obj 130 125 text get \$2 2;
#X text 120 50 Line in \$2 of the data;
#X obj 70 75 t b f b;
#X obj 20 124 v beat-count-\$1;
#X msg 250 112 0;
#X msg 157 177 1;
#X obj 130 150 t a b;
#X connect 0 0 10 0;
#X connect 2 0 4 0;
#X connect 4 0 3 0;
#X connect 8 0 14 0;
#X connect 8 1 6 0;
#X connect 10 0 11 0;
#X connect 10 1 8 0;
#X connect 10 2 12 0;
#X connect 11 0 2 0;
#X connect 12 0 4 1;
#X connect 13 0 4 1;
#X connect 14 0 2 1;
#X connect 14 1 13 0;
#X restore 370 716 pd get-note-duration;
#X text 560 410 Text stores pitch \, velocity \, note duration \, tape
duration \, tape number (starts from 0).;
#X obj 167 417 pack f f 0 -99 -1;
#N canvas 180 0 1162 914 get-next-tape-num 0;
#X obj 80 50 inlet;
#X text 270 30 \$2 is the text store name;
#X text 130 50 Bang;
#X obj 87 277 f 0;
#X obj 59 245 until;
#X obj 140 280 + 1;
#X obj 88 450 f;
#X text 148 450 The value we searched for;
#X obj 88 400 select -1;
#X obj 88 425 t b;
#X text 138 420 We didn't find it \, so output it;
#X obj 73 526 f;
#X obj 510 435 text insert mytest;
#X obj 510 220 text define mytest;
#X text 140 180 Initial values \, incl -1 if not found;
#X obj 53 107 t b b;
#X text 103 526 Save up a value \, output it at the end;
#X obj 87 306 t f f;
#X msg 510 384 list 0 0 0 0 5 \, list 0 0 0 0 2 \, list 0 0 0 0 1 \,
list 0 0 0 0 4 \, list 0 0 0 0 0 \, list 0 0 0 0 3;
#X text 510 190 Data for testing;
#X obj 510 551 text insert mytest;
#X msg 510 500 list 0 0 0 0 5 \, list 0 0 0 0 2 \, list 0 0 0 0 1 \,
list 0 0 0 0 4 \, list 0 0 0 0 0 \, list 0 0 0 0 3;
#X text 510 476 Text with everything present \, should emit -1;
#X text 510 360 Text with a 3 missing \, should emit 3;
#X obj 510 671 text insert mytest;
#X text 510 596 Text with a 3 and a 4 missing \, should emit only one
of these;
#X msg 510 620 list 0 0 0 0 5 \, list 0 0 0 0 2 \, list 0 0 0 0 1 \,
list 0 0 0 0 0;
#X obj 510 317 text delete mytest;
#X msg 510 293 -1;
#X text 510 267 Clear the text;
#X obj 73 551 outlet;
#X text 270 70 Output number of the next tape to be used. The logic
is to search for each tape number \, and store any not found \, and
finally output whatever was last stored.;
#X obj 88 375 text search \$2 4;
#X obj 23 422 t a;
#X text 138 350 Use \$2 for real \, mytest for testing;
#X msg 59 211 6;
#X msg 102 220 0;
#X msg 400 450 -1;
#X obj 400 300 t b;
#X obj 80 180 t b b b;
#X connect 0 0 15 0;
#X connect 3 0 5 0;
#X connect 3 0 17 0;
#X connect 4 0 3 0;
#X connect 5 0 3 1;
#X connect 6 0 11 1;
#X connect 8 0 9 0;
#X connect 9 0 6 0;
#X connect 11 0 30 0;
#X connect 15 0 33 0;
#X connect 15 1 39 0;
#X connect 17 0 32 0;
#X connect 17 1 6 1;
#X connect 18 0 12 0;
#X connect 21 0 20 0;
#X connect 26 0 24 0;
#X connect 28 0 27 0;
#X connect 32 0 8 0;
#X connect 33 0 11 0;
#X connect 35 0 4 0;
#X connect 36 0 3 1;
#X connect 37 0 11 1;
#X connect 38 0 37 0;
#X connect 39 0 35 0;
#X connect 39 1 36 0;
#X connect 39 2 38 0;
#X restore 590 717 pd get-next-tape-num;
#X obj 50 866 outlet;
#X text 481 173 With thanks to Critter & Guitari for cg-note-tracker
\, which can be found in the Pink Mode pattern.;
#X obj 729 717 f;
#X obj 510 687 f;
#X obj 50 671 text get \$2;
#X obj 370 766 text set \$2 0 2;
#X obj 590 767 text set \$2 0 4;
#X obj 370 672 t f f;
#X obj 590 673 t b f;
#X obj 170 805 text set \$2 0 3;
#N canvas 80 80 918 462 calc-tape-duration 0;
#X obj 160 50 inlet;
#X obj 145 402 outlet;
#X text 210 50 Note duration;
#X obj 160 305 random;
#X obj 160 270 t b f;
#X obj 160 75 t f f;
#X obj 160 345 +;
#X obj 160 215 * 3;
#X obj 160 242 + 1;
#X obj 50 50 inlet;
#X text 90 50 Bang;
#X obj 145 370 f;
#X text 320 50 Calculate the duration of a tape. This is 4 to 7 times
its the note duration. Bang to output the value.;
#X text 260 298 This is the minimum of the range;
#X obj 226 298 * 4;
#X text 200 215 This is the exent of the range;
#X obj 274 110 r tape-duration-init-\$1;
#X obj 274 139 unpack f f;
#X obj 294 170 expr $f2 - $f1;
#X connect 0 0 5 0;
#X connect 3 0 6 0;
#X connect 4 0 3 0;
#X connect 4 1 3 1;
#X connect 5 0 7 0;
#X connect 5 1 14 0;
#X connect 6 0 11 1;
#X connect 7 0 8 0;
#X connect 8 0 4 0;
#X connect 9 0 11 0;
#X connect 11 0 1 0;
#X connect 14 0 6 1;
#X connect 16 0 17 0;
#X connect 17 0 18 0;
#X connect 17 0 14 1;
#X connect 17 1 18 1;
#X connect 18 0 7 1;
#X restore 170 765 pd calc-tape-duration;
#X obj 50 622 t f f f f;
#X obj 170 672 t b f;
#X text 769 718 Value \, line number;
#X msg 673 356 clear;
#X text 720 356 For use when testing;
#X obj 560 255 r note-tracker-delete-tape-\$1;
#X text 750 255 Tape to delete;
#X obj 560 280 text search \$2 4;
#X obj 560 305 text delete \$2;
#X text 480 40 Track notes for the tape loops. First outlet outputs
a line if there is a new tape loop to set up. Second outlet says what
tape needs stopping \, if any. There's also an receiver to delete a
line by tape number.;
#X text 480 40 Track notes for the tape loops. First outlet outputs
a line if there is a new tape loop to set up. Second outlet says what
tape needs stopping \, if any. There's also an receiver to delete a
line by tape number.;
#X text 480 124 Logic: Note on writes an entry with dummy note duration
set at the current beat clock count \, tape duration has dummy value
-99 and tape number has dummy value -1;
#X obj 167 267 t a b a a;
#N canvas 456 220 610 474 save-quick-click-time 0;
#X text 170 20 Save the time (in ms) of a note-on. Used to detect a
quick click.;
#X obj 120 170 realtime;
#X obj 119 70 inlet;
#X text 169 70 Pitch and velocity pair;
#X obj 119 95 unpack f f;
#X obj 210 200 text search \$2-click-time 0;
#X obj 210 225 select -1;
#X obj 210 259 text delete \$2-click-time;
#X obj 76 320 text set \$2-click-time 1e+09;
#X obj 76 221 pack f f;
#X obj 119 120 t f b f;
#X text 230 170 Delete an existing value for this note \, if any;
#X obj 20 95 r loadbang-\$1;
#X connect 1 0 9 1;
#X connect 2 0 4 0;
#X connect 4 0 10 0;
#X connect 5 0 6 0;
#X connect 6 1 7 0;
#X connect 9 0 8 0;
#X connect 10 0 9 0;
#X connect 10 1 1 1;
#X connect 10 2 5 0;
#X connect 12 0 1 0;
#X restore 240 300 pd save-quick-click-time;
#X obj 560 510 text define \$2-click-time;
#X text 730 510 Note value and wall clock time;
#N canvas 276 9 684 885 check-quick-click-time 1;
#X obj 230 470 realtime;
#X obj 319 150 inlet;
#X text 369 150 Line number;
#X obj 129 260 unpack f f f f f;
#X obj 129 235 text get \$2;
#X obj 129 290 text search \$2-click-time 0;
#X obj 129 315 select -1;
#X obj 129 385 t f b;
#X obj 130 555 select 0;
#X obj 130 670 f;
#X obj 310 890 f;
#X obj 130 695 outlet;
#X obj 310 1065 outlet;
#X obj 129 360 text get \$2-click-time 1;
#X text 60 695 Slow note;
#X text 367 1066 Quick note;
#X text 180 20 Check the time (in ms) of a note-on-note-off. If it's
not too quick \, pass the input line number to the first outlet. Otherwise
(if it's quick) do a further check. If the previous quick-click was
also very \, very recent then it's a double-quick-click and that's
a signal to stop all tapes - output a bang to the third outlet. Otherwise
it's a single quick-click \, and we output the input line number to
the second outlet.;
#X obj 340 613 t b;
#X obj 340 760 select 0 1;
#X text 40 600 Slow note path;
#X obj 498 851 outlet;
#X text 550 852 Double quick click;
#X obj 319 175 t f f;
#X obj 370 971 f;
#X obj 310 928 t f b;
#X text 420 970 Save this click time as the last one;
#X obj 150 430 r loadbang-\$1;
#X obj 346 209 s quick-click-line-\$1;
#X obj 330 860 r quick-click-line-\$1;
#X obj 150 640 r quick-click-line-\$1;
#X obj 385 941 r quick-click-time-\$1;
#X obj 370 1000 v quick-click-last-time-\$1;
#X obj 457 670 r quick-click-time-\$1;
#X obj 420 330 v quick-click-last-time-\$1;
#X obj 274 530 s quick-click-time-\$1;
#X obj 340 638 v quick-click-last-time-\$1;
#X obj 130 530 expr $f2 - $f1 < 150;
#X text 30 531 Quick is 150ms;
#X obj 340 735 expr $f2 - $f1 < 150;
#X text 478 735 150ms gap between presses;
#X obj 320 1040 print QUICK_CLICK;
#X obj 530 820 print DOUBLE_QUICK_CLICK;
#X obj 120 800 print QUICK_CLICK_LAST_TIME;
#X obj 490 760 print QUICK_CLICK_TIME;
#X obj 457 695 t f f;
#X obj 340 670 t f f;
#X obj 310 963 t f f;
#X obj 379 792 t b b;
#X obj 247 500 t f f f;
#X obj 430 530 print REALTIME;
#X obj 420 280 r loadbang-\$1;
#X msg 420 305 0;
#X connect 0 0 48 0;
#X connect 1 0 22 0;
#X connect 3 0 5 0;
#X connect 4 0 3 0;
#X connect 5 0 6 0;
#X connect 6 1 13 0;
#X connect 7 0 36 0;
#X connect 7 1 0 1;
#X connect 8 0 9 0;
#X connect 8 1 17 0;
#X connect 9 0 11 0;
#X connect 10 0 24 0;
#X connect 13 0 7 0;
#X connect 17 0 35 0;
#X connect 18 0 10 0;
#X connect 18 1 47 0;
#X connect 22 0 4 0;
#X connect 22 1 27 0;
#X connect 23 0 31 0;
#X connect 24 0 46 0;
#X connect 24 1 23 0;
#X connect 26 0 0 0;
#X connect 28 0 10 1;
#X connect 29 0 9 1;
#X connect 30 0 23 1;
#X connect 32 0 44 0;
#X connect 35 0 45 0;
#X connect 36 0 8 0;
#X connect 38 0 18 0;
#X connect 44 0 38 1;
#X connect 44 1 43 0;
#X connect 45 0 38 0;
#X connect 45 1 42 0;
#X connect 46 0 12 0;
#X connect 46 1 40 0;
#X connect 47 0 20 0;
#X connect 47 1 41 0;
#X connect 48 0 36 1;
#X connect 48 1 34 0;
#X connect 48 2 49 0;
#X connect 50 0 51 0;
#X connect 51 0 33 0;
#X restore 50 578 pd check-quick-click-time;
#X msg 683 479 clear;
#X text 730 479 For use when testing;
#N canvas 508 536 454 302 stop-and-delete-tape 0;
#X text 150 30 Stop a tape and delete it from the tracker;
#X obj 60 100 inlet;
#X text 110 100 Line number;
#X text 150 60 \$2 is the text store name;
#X obj 60 125 t f f;
#X text 180 150 Get tape number;
#X obj 87 177 select -1;
#X obj 60 240 text delete \$2;
#X obj 138 211 s tape-to-stop-\$2;
#X obj 87 151 text get \$2 4;
#X connect 1 0 4 0;
#X connect 4 0 7 0;
#X connect 4 1 9 0;
#X connect 6 1 8 0;
#X connect 9 0 6 0;
#X restore 179 620 pd stop-and-delete-tape;
#X obj 340 867 outlet;
#X text 394 867 Tape to stop (if any);
#X obj 340 837 r tape-to-stop-\$2;
#X obj 216 350 s tape-to-stop-\$2;
#N canvas 536 304 618 282 find-line-for-pitch 0;
#X obj 62 42 inlet;
#X text 112 42 Pitch and velocity pair;
#X obj 62 67 unpack f f;
#X obj 62 92 text search \$2;
#X obj 62 121 select -1;
#X obj 62 191 outlet;
#X obj 154 193 outlet;
#X text 202 92 Given a pitch/velocity pair \, find the line number
with that pitch \, or send a bang to the second outlet.;
#X text 202 132 \$2 is the text store name;
#X connect 0 0 2 0;
#X connect 2 0 3 0;
#X connect 3 0 4 0;
#X connect 4 0 6 0;
#X connect 4 1 5 0;
#X restore 50 526 pd find-line-for-pitch;
#N canvas 536 304 674 322 check-okay-to-track 0;
#X obj 119 33 inlet;
#X obj 119 254 outlet;
#X obj 211 254 outlet;
#X text 249 165 \$2 is the text store name;
#X text 247 72 Given a line number \, check it is okay to update with
a tape number - in other words \, that it isn't already committed to
a tape. Output the original line number if okay \, otherwise send a
bang to the second outlet.;
#X text 169 33 Line number;
#X obj 119 87 text get \$2;
#X obj 119 115 unpack f f f f f;
#X obj 119 160 select -1;
#X obj 119 60 t f f;
#X obj 119 200 f;
#X text 40 200 Line number;
#X connect 0 0 9 0;
#X connect 6 0 7 0;
#X connect 7 4 8 0;
#X connect 8 0 10 0;
#X connect 8 1 2 0;
#X connect 9 0 6 0;
#X connect 9 1 10 1;
#X connect 10 0 1 0;
#X restore 50 552 pd check-okay-to-track;
#X obj 596 866 outlet;
#X obj 360 620 s tape-stop-and-delete-all-\$2;
#X obj 596 835 r tape-stop-and-delete-all-\$2;
#X text 650 866 Bang;
#X obj 330 130 r beat-count-\$1;
#X obj 330 185 s beat-count-\$1;
#X obj 187 379 v beat-count-\$1;
#X text 480 103 \$1 is the pattern id. \$2 is the text store name.
;
#X connect 1 0 3 0;
#X connect 3 0 6 0;
#X connect 3 1 10 0;
#X connect 4 0 48 0;
#X connect 5 0 60 0;
#X connect 6 1 7 0;
#X connect 7 0 15 0;
#X connect 7 1 8 0;
#X connect 8 0 4 0;
#X connect 10 0 5 1;
#X connect 10 1 4 1;
#X connect 11 0 59 0;
#X connect 15 0 5 0;
#X connect 16 0 17 0;
#X connect 17 0 18 0;
#X connect 18 0 19 0;
#X connect 18 0 20 0;
#X connect 19 0 67 0;
#X connect 21 0 30 0;
#X connect 21 0 35 1;
#X connect 23 0 9 0;
#X connect 24 0 31 0;
#X connect 27 0 31 1;
#X connect 28 0 30 1;
#X connect 29 0 25 0;
#X connect 32 0 21 0;
#X connect 32 1 28 0;
#X connect 33 0 24 0;
#X connect 33 1 27 0;
#X connect 35 0 34 0;
#X connect 36 0 29 0;
#X connect 36 1 37 0;
#X connect 36 2 32 0;
#X connect 36 3 33 0;
#X connect 37 0 35 0;
#X connect 37 1 34 1;
#X connect 39 0 0 0;
#X connect 41 0 43 0;
#X connect 43 0 44 0;
#X connect 48 0 23 0;
#X connect 48 1 68 0;
#X connect 48 2 11 0;
#X connect 48 3 49 0;
#X connect 52 0 36 0;
#X connect 52 1 55 0;
#X connect 52 2 63 0;
#X connect 53 0 50 0;
#X connect 58 0 56 0;
#X connect 60 0 61 0;
#X connect 61 0 52 0;
#X connect 64 0 62 0;
#X connect 66 0 18 1;
#X connect 68 0 23 2;
